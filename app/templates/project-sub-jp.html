<!DOCTYPE html>
<html>
<head>
    <title>プロジェクト割り当て</title>
    <link rel="stylesheet" type="text/css" href="/static/css/home.css">
    <script>
        const current_user_name = "{{ username }}";
        const page_language = "jp";
    </script>
</head>
<body>
    <div class="header-container">
        <h1>ようこそ, {{ username }}さん!</h1>
        <form action="/logout" method="post">
            <input type="submit" value="ログアウト">
            <input type="hidden" name="lang" value="jp">
        </form>
        <nav>
            <a href="/home-jp?username={{ username }}&role={{ role }}&password={{ password }}">ホーム</a>
        </nav>
        <a class="JPpage" href="/project-sub?username={{ username }}&role={{ role }}&password={{ password }}&lang=en">英語</a>
    </div>

    <div class="container">
        {% if role == 'projectmanager' %}
        <p>あなたはプロジェクトマネージャーです。</p>
        {% endif %}

        <p>プロジェクトをユーザーに割り当てます：</p>
        <p>本日以前の出席記録は追加されません。</p>
        <p>編集によってプロジェクトの日付が変更された場合、出席記録もそれに応じて更新されます。</p>

        <!-- 今日より前の出勤記録は登録できないぞ！ -->
        <form action="/pm_create_attendance" method="post" onsubmit="packageDates()">
            <input type="hidden" name="username" value="{{ username }}">
            <input type="hidden" name="role" value="{{ role }}">
            <input type="hidden" name="password" value="{{ password }}">
            <input type="hidden" name="lang" value="jp">
        
            <label for="pmasu_the_project_name">プロジェクト名：</label>
            <select id="pmasu_the_project_name" name="pmasu_the_project_name" required onchange="fetchDates()">
                <option value="">プロジェクトを選択してください</option>
            </select>
        
            <label for="pmasu_the_user_name">ユーザー名：</label>
            <select id="pmasu_the_user_name" name="pmasu_the_user_name" required>
                <option value="">ユーザーを選択してください</option>
            </select>
        
            <label for="attendance_dates">日付：</label>
            <div id="date-options">
                <!-- ここに日付のチェックボックスが生成されます -->
            </div>
        
            <!-- 選択された日付を送信するための隠しフィールド -->
            <input type="hidden" id="selected_dates" name="selected_dates">
        
            <input type="submit" value="割り当て">
        </form>
        
        <script>
            async function fetchDates() {
                const projectName = document.getElementById("pmasu_the_project_name").value;
                if (!projectName) {
                    document.getElementById("date-options").innerHTML = "";
                    return;
                }
        
                try {
                    // エンドポイントから日付リストを取得
                    const response = await fetch(`/get_dates_from_project_name/${encodeURIComponent(projectName)}`);
                    const dates = await response.json();
        
                    // 日付を基にチェックボックスを生成
                    const dateOptionsContainer = document.getElementById("date-options");
                    dateOptionsContainer.innerHTML = "";
                    dates.forEach(dateStr => {
                        const date = new Date(dateStr);
                        const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
        
                        const label = document.createElement("label");
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.name = "attendance_dates[]";
                        checkbox.value = dateStr;
                        checkbox.checked = !isWeekend;  // 週末の場合のみチェック
        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(dateStr + (isWeekend ? " (週末)" : "")));
                        dateOptionsContainer.appendChild(label);
                        // dateOptionsContainer.appendChild(document.createElement("br"));
                    });
                } catch (error) {
                    console.error("日付のフェッチエラー:", error);
                }
            }
        
            function packageDates() {
                // 選択された日付をリストとして取得
                const selectedDates = Array.from(document.querySelectorAll('input[name="attendance_dates[]"]:checked'))
                                           .map(checkbox => checkbox.value);
        
                // 隠しフィールドにリストを JSON 形式で格納
                document.getElementById("selected_dates").value = JSON.stringify(selectedDates);
            }
        </script>

        {% if pm_createattendance_message %}
        <div class="message {% if pm_createattendance_success %}success{% else %}error{% endif %}">
            {{ pm_createattendance_message }}
        </div>
        {% endif %}

        <p>ユーザーへのプロジェクトの割り当てを解除します：</p>
        <form action="/pm_delete_attendance" method="post" onsubmit="packageSelectedDates()">
            <input type="hidden" name="username" value="{{ username }}">
            <input type="hidden" name="role" value="{{ role }}">
            <input type="hidden" name="password" value="{{ password }}">
            <input type="hidden" name="lang" value="jp">
        
            <label for="pmuasu_the_project_name">プロジェクト名：</label>
            <select id="pmuasu_the_project_name" name="pmuasu_the_project_name" required onchange="fetchAttendanceDates()">
                <option value="">プロジェクトを選択してください</option>
            </select>
        
            <label for="pmuasu_the_user_name">ユーザー名：</label>
            <select id="pmuasu_the_user_name" name="pmuasu_the_user_name" required onchange="fetchAttendanceDates()">
                <option value="">ユーザーを選択してください</option>
            </select>
        
            <label for="pm_remove_attendance_dates">以下の日付の記録を削除する：</label>
            <div id="pm_remove_date_options">
                <!-- ここに日付のチェックボックスが生成されます -->
            </div>
        
            <!-- 選択された日付を送信するための隠しフィールド -->
            <input type="hidden" id="pm_remove_selected_dates" name="pm_remove_selected_dates">
        
            <input type="submit" value="割り当て解除">
        </form>
        
        <script>
            async function fetchAttendanceDates() {
                const projectName = document.getElementById("pmuasu_the_project_name").value;
                const userName = document.getElementById("pmuasu_the_user_name").value;
        
                if (!projectName || !userName) {
                    document.getElementById("pm_remove_date_options").innerHTML = "";
                    return;
                }
        
                try {
                    // エンドポイントから日付リストを取得
                    const response = await fetch(`/attendances_get_dates/${encodeURIComponent(userName)}/${encodeURIComponent(projectName)}`);
                    const dates = await response.json();
        
                    // 日付を基にチェックボックスを生成
                    const dateOptionsContainer = document.getElementById("pm_remove_date_options");
                    dateOptionsContainer.innerHTML = "";
                    dates.forEach(dateStr => {
                        const date = new Date(dateStr);
                        const isWeekend = (date.getDay() === 0 || date.getDay() === 6); // 週末判定
        
                        const label = document.createElement("label");
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.name = "pm_remove_attendance_dates[]";
                        checkbox.value = dateStr;
                        checkbox.checked = true
        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(dateStr + (isWeekend ? " (週末)" : "")));
                        dateOptionsContainer.appendChild(label);
                        // dateOptionsContainer.appendChild(document.createElement("br"));
                    });
                } catch (error) {
                    console.error("日付のフェッチエラー:", error);
                }
            }
        
            function packageSelectedDates() {
                // 選択された日付をリストとして取得
                const selectedDates = Array.from(document.querySelectorAll('input[name="pm_remove_attendance_dates[]"]:checked'))
                                           .map(checkbox => checkbox.value);
        
                // 隠しフィールドにリストを JSON 形式で格納
                document.getElementById("pm_remove_selected_dates").value = JSON.stringify(selectedDates);
            }
        </script>

        {% if pm_deleteattendance_message %}
        <div class="message {% if pm_deleteattendance_success %}success{% else %}error{% endif %}">
            {{ pm_deleteattendance_message }}
        </div>
        {% endif %}

        {% if error %}
        <div class="message error">
            {{ error }}
        </div>
        {% endif %}
    </div>
    <script src="/static/js/home.js"></script>
</body>
</html>
