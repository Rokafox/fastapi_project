<!DOCTYPE html>
<html>
<head>
    <title>ホーム</title>
    <link rel="stylesheet" type="text/css" href="/static/css/home.css">
</head>
<body>
    <div class="header-container">
        <h1>ようこそ, {{ username }}さん!</h1>
        <a class="JPpage" href="/home?username={{ username }}&role={{ role }}&password={{ password }}">英語</a>
    </div>

    <div class="container">
        <p>ログインに成功しました！</p>
        <form action="/logout" method="post">
            <input type="submit" value="ログアウト">
            <input type="hidden" name="lang" value="jp">
        </form>
        <p>パスワード編集：</p>
        <form action="/genericuser_change_password" method="post">
            <input type="hidden" name="username" value="{{ username }}">
            <input type="hidden" name="role" value="{{ role }}">
            <input type="hidden" name="password" value="{{ password }}">
            <input type="hidden" name="lang" value="jp">

            <p>パスワードは4文字以上でなければなりません。</p>
            <input type="password" id="newpassword" name="newpassword" required>

            <input type="submit" value="編集">
        </form>
        {% if genericuser_changepassword_message %}
            <div class="message {% if genericuser_changepassword_success %}success{% else %}error{% endif %}">
                {{ genericuser_changepassword_message }}
            </div>
        {% endif %}
        
        {% if role == 'sysadmin' %}
            <p>あなたはシステム管理者です。</p>
            <p>ユーザーを作成します：</p>
            <form action="/sysadmin_create_user" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="jp">

                <label for="newuser_name">ユーザー名：</label>
                <input type="text" id="newuser_name" name="newuser_name" required>

                <label for="newuser_password">パスワード：</label>
                <p>パスワードは4文字以上でなければなりません。</p>
                <input type="password" id="newuser_password" name="newuser_password" required>

                <label for="newuser_role">役割：</label>
                <select id="newuser_role" name="newuser_role">
                    <option value="hiruchaaru">ヒルチャール</option>
                    <option value="projectmanager">プロジェクトマネージャー</option>
                </select>

                <input type="submit" value="ユーザー作成">
            </form>

            {% if sysadmin_createuser_message %}
                <div class="message {% if sysadmin_createuser_success %}success{% else %}error{% endif %}">
                    {{ sysadmin_createuser_message }}
                </div>
            {% endif %}

            <p>ユーザーを削除します：</p>
            <form action="/sysadmin_delete_user" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="jp">

                <label for="deleteuser_name">ユーザー名：</label>
                <input type="text" id="deleteuser_name" name="deleteuser_name" required>
            
                <input type="submit" value="ユーザー削除">
            </form>
            
            {% if sysadmin_deleteuser_message %}
                <div class="message {% if sysadmin_deleteuser_success %}success{% else %}error{% endif %}">
                    {{ sysadmin_deleteuser_message }}
                </div>
            {% endif %}



            <p>ユーザー一覧：</p>

            <button id="show-users-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">表示</button>
            <button id="hide-users-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">隠す</button>

            <input type="text" id="filter-input" placeholder="高性能フェルータ" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>

            <ul id="user-list" style="display: none;">
                <!-- ユーザーリストがここに表示されます -->
            </ul>

            <script>
                let users = [];

                document.getElementById('show-users-btn').addEventListener('click', () => {
                    fetchUsers();
                    document.getElementById('filter-input').style.display = 'block';
                    document.getElementById('user-list').style.display = 'block';
                    document.getElementById('show-users-btn').style.display = 'none';
                    document.getElementById('hide-users-btn').style.display = 'block';
                });

                document.getElementById('hide-users-btn').addEventListener('click', () => {
                    document.getElementById('filter-input').style.display = 'none';
                    document.getElementById('user-list').style.display = 'none';
                    document.getElementById('hide-users-btn').style.display = 'none';
                    document.getElementById('show-users-btn').style.display = 'block';
                });

                document.getElementById('filter-input').addEventListener('input', filterUsers);

                async function fetchUsers() {
                    const response = await fetch('/users');
                    users = await response.json();
                    displayUsers(users);
                }

                function displayUsers(userList) {
                    const userListElement = document.getElementById('user-list');
                    userListElement.innerHTML = '';

                    userList.forEach(user => {
                        const listItem = document.createElement('li');
                        let editButtonHTML = '';

                        // 現在のユーザー名と一致しない場合のみ編集ボタンを表示
                        if (user.name !== "{{ username }}") {
                            editButtonHTML = `<button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="editUser(${user.id})">編集</button>`;
                        }
                        // can't edit sysadmin
                        // if (user.role !== "sysadmin") {
                        //     editButtonHTML = `<button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="editUser(${user.id})">Edit</button>`;
                        // }

                        // We will do it backend instead.
                        // let password = user.name === "rokafox" ? "???" : user.password;
                        // let role = user.name === "rokafox" ? "???" : user.role;


                        let password = user.password;
                        let role = user.role;
                        if (user.name === "rokafox") {
                            editButtonHTML = '';
                        }

                        listItem.innerHTML = `
                            <strong>名：</strong> ${user.name} <br>
                            <strong>パスワード：</strong> ${password} <br>
                            <strong>役割：</strong> ${role} <br>
                            ${editButtonHTML}
                        `;
                        userListElement.appendChild(listItem);
                    });
                }


                function filterUsers() {
                    const filterValue = document.getElementById('filter-input').value.toLowerCase();
                    const filteredUsers = users.filter(user => 
                        user.name.toLowerCase().includes(filterValue) ||
                        user.password.toLowerCase().includes(filterValue) ||
                        user.role.toLowerCase().includes(filterValue)
                    );
                    displayUsers(filteredUsers);
                }

                async function editUser(userId) {
                    // 選択したユーザーのデータを取得
                    const user = users.find(u => u.id === userId);

                    // フォームにユーザーのデータをセット
                    document.getElementById('edit-name').value = user.name;
                    document.getElementById('edit-password').value = user.password;
                    document.getElementById('edit-role').value = user.role;

                    // 編集モーダルを表示
                    document.getElementById('edit-user-modal').style.display = 'block';

                    // フォームのサブミット処理
                    document.getElementById('edit-user-form').onsubmit = async (e) => {
                        e.preventDefault();

                        // フォームからデータを取得
                        const updatedUser = {
                            name: document.getElementById('edit-name').value,
                            password: document.getElementById('edit-password').value,
                            role: document.getElementById('edit-role').value,
                        };

                        // サーバーにPATCHリクエストを送信
                        const response = await fetch(`/users/${userId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedUser),
                        });

                        const response_result = await response.json();
                        if (response_result.success) {
                            fetchUsers();
                            // モーダルを非表示
                            document.getElementById('edit-user-modal').style.display = 'none';
                        } else {
                            alert('Failed to update user: ' + response_result.message);  // エラーメッセージを表示
                        }
                    };

                    // キャンセルボタンの処理
                    document.getElementById('cancel-edit').addEventListener('click', () => {
                        document.getElementById('edit-user-modal').style.display = 'none';
                    });
                }
            </script>

            <div id="edit-user-modal" style="display: none;">
                <p>ユーザー編集：</p>
                <form id="edit-user-form">
                    <label for="edit-name">名：</label>
                    <input type="text" id="edit-name" required><br>

                    <label for="edit-password">パスワード：</label>
                    <input type="text" id="edit-password" required><br>

                    <label for="edit-role">役割：</label>
                    <select id="edit-role" required>
                        <option value="sysadmin">システム管理者</option>
                        <option value="projectmanager">プロジェクトマネージャー</option>
                        <option value="hiruchaaru">ヒルチャール</option>
                    </select><br>

                    <button type="submit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">保存</button>
                    <button type="button" id="cancel-edit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">キャンセル</button>

                </form>
            </div>



            <p>新規プロジェクト作成：</p>
            <form action="/sysadmin_create_project" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="jp">

                <label for="newproject_name">プロジェクト名：</label>
                <input type="text" id="newproject_name" name="newproject_name" required>

                <label for="newproject_description">プロジェクト内容：</label>
                <textarea id="newproject_description" name="newproject_description" rows="4" required></textarea>

                <label for="newproject_startdate">開始日：</label>
                <input type="date" id="newproject_startdate" name="newproject_startdate" required>

                <label for="newproject_enddate">締切日：</label>
                <input type="date" id="newproject_enddate" name="newproject_enddate" required>

                <label for="newproject_starttime">開始時間：</label>
                <input type="time" id="newproject_starttime" name="newproject_starttime" value="09:00" required>

                <label for="newproject_endtime">終了時間：</label>
                <input type="time" id="newproject_endtime" name="newproject_endtime" value="16:00" required>

                <label for="newproject_status">状態：</label>
                <select id="newproject_status" name="newproject_status">
                    <option value="scheduled">予定</option>
                    <option value="ongoing">進行中</option>
                    <option value="Requirements_Definition">要件定義</option>
                    <option value="Basic_Design">基本設計</option>
                    <option value="Detailed_Design">詳細設計</option>
                    <option value="Programming">プログラミング</option>
                    <option value="Unit_Testing">単体テスト</option>
                    <option value="Integration_Testing">結合テスト</option>
                    <option value="System_Testing">システムテスト</option>
                </select>
                <label for="project_manager_names">プロジェクトマネージャー(カンマで区切って複数記入可):</label>
                <input type="text" id="project_manager_names" name="project_manager_names" placeholder="マネージャー名を入力" required>
            
                <input type="submit" value="プロジェクト作成">
            </form>

            {% if sysadmin_createproject_message %}
                <div class="message {% if sysadmin_createproject_success %}success{% else %}error{% endif %}">
                    {{ sysadmin_createproject_message }}
                </div>
            {% endif %}

            <p>プロジェクトマネージャーをプロジェクトから退任させる：</p>
            <form action="/sysadmin_retire_project_manager" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="jp">

                <label for="retireprojectmanager_name">プロジェクトマネージャー名：</label>
                <input type="text" id="retireprojectmanager_name" name="retireprojectmanager_name" required>

                <label for="retireproject_name">プロジェクト名：</label>
                <input type="text" id="retireproject_name" name="retireproject_name" required>
            
                <input type="submit" value="クビ">
            </form>
            
            {% if sysadmin_retireprojectmanager_message %}
                <div class="message {% if sysadmin_retireprojectmanager_success %}success{% else %}error{% endif %}">
                    {{ sysadmin_retireprojectmanager_message }}
                </div>
            {% endif %}


            <p>プロジェクトマネージャをプロジェクトに割り当てる：</p>
            <form action="/sysadmin_assign_project_manager" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="jp">

                <label for="assignprojectmanager_name">プロジェクトマネージャー名：</label>
                <input type="text" id="assignprojectmanager_name" name="assignprojectmanager_name" required>

                <label for="assignproject_name">プロジェクト名：</label>
                <input type="text" id="assignproject_name" name="assignproject_name" required>
            
                <input type="submit" value="割り当てる">
            </form>
                
            {% if sysadmin_assignprojectmanager_message %}
                <div class="message {% if sysadmin_assignprojectmanager_success %}success{% else %}error{% endif %}">
                    {{ sysadmin_assignprojectmanager_message }}
                </div>
            {% endif %}


            <p>プロジェクト一覧：</p>

            <button id="sysadmin-show-projects-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">プロジェクト表示</button>
            <button id="sysadmin-hide-projects-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">プロジェクト隠す</button>
            
            <input type="text" id="sysadmin-filter-input" placeholder="高性能フェルータ" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>
            
            <ul id="sysadmin-project-list" style="display: none;">
                <!-- プロジェクトリストがここに表示されます -->
            </ul>
            
            <script>
                let sysadmin_projects = [];
            
                document.getElementById('sysadmin-show-projects-btn').addEventListener('click', () => {
                    sysadminFetchProjects();
                    document.getElementById('sysadmin-filter-input').style.display = 'block';
                    document.getElementById('sysadmin-project-list').style.display = 'block';
                    document.getElementById('sysadmin-show-projects-btn').style.display = 'none';
                    document.getElementById('sysadmin-hide-projects-btn').style.display = 'block';
                });
            
                document.getElementById('sysadmin-hide-projects-btn').addEventListener('click', () => {
                    document.getElementById('sysadmin-filter-input').style.display = 'none';
                    document.getElementById('sysadmin-project-list').style.display = 'none';
                    document.getElementById('sysadmin-hide-projects-btn').style.display = 'none';
                    document.getElementById('sysadmin-show-projects-btn').style.display = 'block';
                });
            
                document.getElementById('sysadmin-filter-input').addEventListener('input', sysadminFilterProjects);
            
                async function sysadminFetchProjects() {
                    const response = await fetch('/projects');
                    sysadmin_projects = await response.json();
                    sysadminDisplayProjects(sysadmin_projects);
                }
            
                function sysadminDisplayProjects(projectList) {
                    const projectListElement = document.getElementById('sysadmin-project-list');
                    projectListElement.innerHTML = ''; // リストをクリア
            
                    projectList.forEach(project => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>名:</strong> ${project.name} <br>
                            <strong>説明:</strong> ${project.description} <br>
                            <strong>開始時間:</strong> ${project.starttime} <br>
                            <strong>終了時間:</strong> ${project.endtime} <br>
                            <strong>状態:</strong> ${project.status} <br>
                            <strong>マネージャー:</strong> ${project.managers} <br>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="sysadminEditProject(${project.id})">編集</button>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="sysadminDeleteProject(${project.id})">削除</button>
                        `;
                        projectListElement.appendChild(listItem);
                    });
                }
            
                function sysadminFilterProjects() {
                    const filterValue = document.getElementById('sysadmin-filter-input').value.toLowerCase();
                    const filteredProjects = sysadmin_projects.filter(project => 
                        project.name.toLowerCase().includes(filterValue) ||
                        project.description.toLowerCase().includes(filterValue) ||
                        project.starttime.toLowerCase().includes(filterValue) ||
                        project.endtime.toLowerCase().includes(filterValue) ||
                        project.status.toLowerCase().includes(filterValue) ||
                        project.managers.some(manager => manager.toLowerCase().includes(filterValue))
                    );
                    sysadminDisplayProjects(filteredProjects);
                }
            
                async function sysadminEditProject(projectId) {
                    const project = sysadmin_projects.find(p => p.id === projectId);
            
                    document.getElementById('sysadmin-edit-name').value = project.name;
                    document.getElementById('sysadmin-edit-description').value = project.description;
                    document.getElementById('sysadmin-edit-starttime').value = project.starttime;
                    document.getElementById('sysadmin-edit-endtime').value = project.endtime;
                    document.getElementById('sysadmin-edit-status').value = project.status;
            
                    document.getElementById('sysadmin-edit-project-modal').style.display = 'block';
            
                    document.getElementById('sysadmin-edit-project-form').onsubmit = async (e) => {
                        e.preventDefault();
            
                        const updatedProject = {
                            name: document.getElementById('sysadmin-edit-name').value,
                            description: document.getElementById('sysadmin-edit-description').value,
                            starttime: document.getElementById('sysadmin-edit-starttime').value.replace('T', ' '),
                            endtime: document.getElementById('sysadmin-edit-endtime').value.replace('T', ' '),
                            status: document.getElementById('sysadmin-edit-status').value,
                        };
            
                        const response = await fetch(`/projects/${projectId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedProject),
                        });
            
                        const response_result = await response.json();
                        if (response_result.success) {
                            sysadminFetchProjects();
                            document.getElementById('sysadmin-edit-project-modal').style.display = 'none';
                        } else {
                            alert('Failed to update project: ' + response_result.message);
                        }
            
                    };
            
                    document.getElementById('sysadmin-cancel-edit').addEventListener('click', () => {
                        document.getElementById('sysadmin-edit-project-modal').style.display = 'none';
                    });
                }
            
                async function sysadminDeleteProject(projectId) {
                    const confirmation = confirm(`Are you sure you want to delete this project?`);
                    if (!confirmation) {
                        return;
                    }
            
                    try {
                        const response = await fetch(`/projects/${projectId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        const response_result = await response.json();
            
                        if (response_result.success) {
                            sysadminFetchProjects();
                        } else {
                            const errorData = await response.json();
                            alert(`Failed to delete project: ${errorData.detail}`);
                        }
                    } catch (error) {
                        console.error('Error deleting project:', error);
                        alert('An error occurred while deleting the project.');
                    }
                }
            </script>
            
            <div id="sysadmin-edit-project-modal" style="display: none;">
                <p>プロジェクト編集：</p>
                <form id="sysadmin-edit-project-form">
                    <label for="sysadmin-edit-name">名：</label>
                    <input type="text" id="sysadmin-edit-name" required><br>
            
                    <label for="sysadmin-edit-description">説明：</label>
                    <textarea id="sysadmin-edit-description" rows="4" required></textarea><br>
            
                    <label for="sysadmin-edit-starttime">開始日と予定開始時間</label>
                    <input type="datetime-local" id="sysadmin-edit-starttime" required><br>
            
                    <label for="sysadmin-edit-endtime">終了日と予定終了時間</label>
                    <input type="datetime-local" id="sysadmin-edit-endtime" required><br>
            
                    <label for="sysadmin-edit-status">状態：</label>
                    <select id="sysadmin-edit-status" required>
                        <option value="scheduled">予定済み</option>
                        <option value="ongoing">進行中</option>
                        <option value="Requirements_Definition">要件定義</option>
                        <option value="Basic_Design">基本設計</option>
                        <option value="Detailed_Design">詳細設計</option>
                        <option value="Programming">プログラミング</option>
                        <option value="Unit_Testing">単体テスト</option>
                        <option value="Integration_Testing">統合テスト</option>
                        <option value="System_Testing">システムテスト</option>                        
                    </select><br>
            
                    <button type="submit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">保存</button>

                    <button type="button" id="sysadmin-cancel-edit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">キャンセル</button>
                </form>
            </div>





        {% endif %}

        {% if role == 'hiruchaaru' %}
        <!--ヒルチャールのお兄さんが病気になった♪
            ヒルチャールのお姉さんが看病して♪
            ヒルチャールのお兄さんが薬を飲んでも治らない♪-->
            <p>貴方はヒルチャールです。</p>
            <p>登録プロジェクトを表示：</p>

            <button id="show-attendances-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">プロジェクト表示</button>
            <button id="hide-attendances-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">プロジェクト隠す</button>
            
            <input type="text" id="filter-input" placeholder="高性能フェルータ" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>
            
            <ul id="attendance-list" style="display: none;">
                <!-- 出席リストがここに表示されます -->
            </ul>
            
            <script>
                let hiruchaaru_attendances = [];
            
                document.getElementById('show-attendances-btn').addEventListener('click', () => {
                    fetchAttendances();
                    document.getElementById('filter-input').style.display = 'block';
                    document.getElementById('attendance-list').style.display = 'block';
                    document.getElementById('show-attendances-btn').style.display = 'none';
                    document.getElementById('hide-attendances-btn').style.display = 'block';
                });
            
                document.getElementById('hide-attendances-btn').addEventListener('click', () => {
                    document.getElementById('filter-input').style.display = 'none';
                    document.getElementById('attendance-list').style.display = 'none';
                    document.getElementById('hide-attendances-btn').style.display = 'none';
                    document.getElementById('show-attendances-btn').style.display = 'block';
                });
            
                document.getElementById('filter-input').addEventListener('input', filterAttendances);
            
                async function fetchAttendances() {
                    const userName = '{{ username }}';
                    const response = await fetch(`/attendances/${userName}`);
                    hiruchaaru_attendances = await response.json();
                    displayAttendances(hiruchaaru_attendances);
                }
            
                function displayAttendances(attendanceList) {
                    const attendanceListElement = document.getElementById('attendance-list');
                    attendanceListElement.innerHTML = ''; // リストをクリア
            
                    attendanceList.forEach(attendance => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>Project:</strong> ${attendance.project_name} <br>
                            <strong>Scheduled Starttime:</strong> ${attendance.project_starttime} <br>
                            <strong>Scheduled Endtime:</strong> ${attendance.project_endtime} <br>
                            <strong>Date:</strong> ${attendance.date} <br>
                            <strong>Check In:</strong> ${attendance.check_in ? attendance.check_in : '出勤していません'} <br>
                            <strong>Check Out:</strong> ${attendance.check_out ? attendance.check_out : '退勤していません'} <br>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="checkIn('${attendance.id}')">出勤</button>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="checkOut('${attendance.id}')">退勤</button>
                        `;
                        attendanceListElement.appendChild(listItem);
                    });
                }
            
                async function checkIn(attendanceId) {
                    const response = await fetch(`/attendances/${attendanceId}/checkin`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: ''
                    });
                    const response_result = await response.json();

                    if (response_result.success) {
                        alert('出勤を記録したぞ！');
                        fetchAttendances(); // 再読み込みしてリストを更新
                    } else {
                        alert('出勤失敗！これはバグであろう。');
                    }
                }
            
                async function checkOut(attendanceId) {
                    const response = await fetch(`/attendances/${attendanceId}/checkout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: ''
                    });
                    const response_result = await response.json();
            
                    if (response_result.success) {
                        alert('退勤したぞ！');
                        fetchAttendances(); // 再読み込みしてリストを更新
                    } else {
                        alert('失敗。これはバグであろう。');
                    }
                }
            
                function filterAttendances() {
                    const filterValue = document.getElementById('filter-input').value.toLowerCase();
                    const filteredAttendances = hiruchaaru_attendances.filter(attendance => 
                        attendance.project_name.toLowerCase().includes(filterValue) ||
                        attendance.project_starttime.toLowerCase().includes(filterValue) ||
                        attendance.project_endtime.toLowerCase().includes(filterValue) ||
                        attendance.date.toLowerCase().includes(filterValue)
                    );
                    displayAttendances(filteredAttendances);
                }
            </script>

            <p>タスクを表示:</p>

            <button id="hrctsk-show-tasks-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">タスク表示</button>
            <button id="hrctsk-hide-tasks-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">タスク隠す</button>

            <input type="text" id="hrctsk-filter-input" placeholder="高性能フェルータ" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>

            <ul id="hrctsk-task-list" style="display: none;">
                <!-- タスクリストがここに表示されます -->
            </ul>

            <script>
                let hrctasks = [];

                document.getElementById('hrctsk-show-tasks-btn').addEventListener('click', () => {
                    fetchTasks();
                    document.getElementById('hrctsk-filter-input').style.display = 'block';
                    document.getElementById('hrctsk-task-list').style.display = 'block';
                    document.getElementById('hrctsk-show-tasks-btn').style.display = 'none';
                    document.getElementById('hrctsk-hide-tasks-btn').style.display = 'block';
                });

                document.getElementById('hrctsk-hide-tasks-btn').addEventListener('click', () => {
                    document.getElementById('hrctsk-filter-input').style.display = 'none';
                    document.getElementById('hrctsk-task-list').style.display = 'none';
                    document.getElementById('hrctsk-hide-tasks-btn').style.display = 'none';
                    document.getElementById('hrctsk-show-tasks-btn').style.display = 'block';
                });

                document.getElementById('hrctsk-filter-input').addEventListener('input', filterTasks);

                async function fetchTasks() {
                    const response = await fetch(`/tasks_for_specific_hiruchaaru/{{ username }}`);
                    hrctasks = await response.json();
                    displayTasks(hrctasks);
                }

                function displayTasks(taskList) {
                    const taskListElement = document.getElementById('hrctsk-task-list');
                    taskListElement.innerHTML = '';

                    taskList.forEach(task => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>プロジェクト：</strong> ${task.project_name} <br>
                            <strong>開始日：</strong> ${task.start_date} <br>
                            <strong>終了日：</strong> ${task.end_date} <br>
                            <strong>詳細情報：</strong> ${task.status} <br>
                        `;
                        // task_assigned_for_this_user が True の場合のみ「Edit」ボタンを表示
                        if (task.task_assigned_for_this_user) {
                            listItem.innerHTML += `
                                <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="editTask(${task.id})">編集</button>
                            `;
                        }
                        taskListElement.appendChild(listItem);
                    });
                }

                function filterTasks() {
                    const filterValue = document.getElementById('hrctsk-filter-input').value.toLowerCase();
                    const filteredTasks = hrctasks.filter(task => 
                        task.project_name.toLowerCase().includes(filterValue) ||
                        task.start_date.toLowerCase().includes(filterValue) ||
                        task.end_date.toLowerCase().includes(filterValue) ||
                        (task.status && task.status.toLowerCase().includes(filterValue))
                    );
                    displayTasks(filteredTasks);
                }

                async function editTask(taskId) {
                    const task = hrctasks.find(t => t.id === taskId);

                    document.getElementById('hrctsk-edit-status').value = task.status || '';

                    document.getElementById('hrctsk-edit-task-modal').style.display = 'block';

                    document.getElementById('hrctsk-edit-task-form').onsubmit = async (e) => {
                        e.preventDefault();

                        const updatedTask = {
                            status: document.getElementById('hrctsk-edit-status').value,
                        };

                        const response = await fetch(`/tasks/${taskId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedTask),
                        });

                        const response_result = await response.json();
                        if (response_result.success) {
                            fetchTasks();
                            document.getElementById('hrctsk-edit-task-modal').style.display = 'none';
                        } else {
                            alert('Failed to update task: ' + response_result.message);
                        }
                    };

                    document.getElementById('hrctsk-cancel-edit').addEventListener('click', () => {
                        document.getElementById('hrctsk-edit-task-modal').style.display = 'none';
                    });
                }
            </script>

            <div id="hrctsk-edit-task-modal" style="display: none;">
                <p>タスク編集：</p>
                <form id="hrctsk-edit-task-form">
                    <label for="hrctsk-edit-status">詳細情報：</label>
                    <textarea id="hrctsk-edit-status" rows="4"></textarea><br>

                    <button type="submit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">Save</button>
                    <button type="button" id="hrctsk-cancel-edit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">Cancel</button>
                </form>
            </div>
            <div id="hrctsk-edit-task-modal" style="display: none;">
                <p>タスク編集：</p>
                <form id="hrctsk-edit-task-form">
                    <label for="hrctsk-edit-status">詳細情報：</label>
                    <textarea id="hrctsk-edit-status" rows="4"></textarea><br>
            
                    <button type="submit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">Save</button>
                    <button type="button" id="hrctsk-cancel-edit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">Cancel</button>
                </form>
            </div>
            

        {% endif %}

        {% if role == 'projectmanager' %}
            <p>貴方はプロジェクトマネージャーです</p>
            <p>プロジェクト閲覧：</p>

            <button id="show-projects-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">プロジェクト表示</button>
            <button id="hide-projects-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">プロジェクト隠す</button>
            
            <input type="text" id="filter-input" placeholder="Smart Filter" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>
            
            <ul id="project-list" style="display: none;">
                <!-- プロジェクトリストがここに表示されます -->
            </ul>
            
            <script>
                let projects = [];
            
                document.getElementById('show-projects-btn').addEventListener('click', () => {
                    fetchProjects();
                    document.getElementById('filter-input').style.display = 'block';
                    document.getElementById('project-list').style.display = 'block';
                    document.getElementById('show-projects-btn').style.display = 'none';
                    document.getElementById('hide-projects-btn').style.display = 'block';
                });
            
                document.getElementById('hide-projects-btn').addEventListener('click', () => {
                    document.getElementById('filter-input').style.display = 'none';
                    document.getElementById('project-list').style.display = 'none';
                    document.getElementById('hide-projects-btn').style.display = 'none';
                    document.getElementById('show-projects-btn').style.display = 'block';
                });
            
                document.getElementById('filter-input').addEventListener('input', filterProjects);
            
                async function fetchProjects() {
                    // fetch from @app.get("/projects_pm/{project_manager_name}")
                    const project_manager_name = '{{ username }}';
                    const response = await fetch(`/projects_pm/${project_manager_name}`);
                    projects = await response.json();
                    displayProjects(projects);
                }
            
                function displayProjects(projectList) {
                    const projectListElement = document.getElementById('project-list');
                    projectListElement.innerHTML = ''; // リストをクリア
            
                    projectList.forEach(project => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>名前:</strong> ${project.name} <br>
                            <strong>説明:</strong> ${project.description} <br>
                            <strong>開始時間:</strong> ${project.starttime} <br>
                            <strong>終了時間:</strong> ${project.endtime} <br>
                            <strong>状態:</strong> ${project.status} <br>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="editProject(${project.id})">編集</button>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="deleteProject(${project.id})">削除</button>
                        `;
                        projectListElement.appendChild(listItem);
                    });
                }
            
                function filterProjects() {
                    const filterValue = document.getElementById('filter-input').value.toLowerCase();
                    const filteredProjects = projects.filter(project => 
                        project.name.toLowerCase().includes(filterValue) ||
                        project.description.toLowerCase().includes(filterValue) ||
                        project.starttime.toLowerCase().includes(filterValue) ||
                        project.endtime.toLowerCase().includes(filterValue) ||
                        project.status.toLowerCase().includes(filterValue)
                    );
                    displayProjects(filteredProjects);
                }
            
                async function editProject(projectId) {
                    // 選択したプロジェクトのデータを取得
                    const project = projects.find(p => p.id === projectId);

                    // フォームにプロジェクトのデータをセット
                    document.getElementById('edit-name').value = project.name;
                    document.getElementById('edit-description').value = project.description;
                    document.getElementById('edit-starttime').value = project.starttime;
                    document.getElementById('edit-endtime').value = project.endtime;
                    document.getElementById('edit-status').value = project.status;

                    // 編集モーダルを表示
                    document.getElementById('edit-project-modal').style.display = 'block';

                    // フォームのサブミット処理
                    document.getElementById('edit-project-form').onsubmit = async (e) => {
                        e.preventDefault();

                        // フォームからデータを取得
                        const updatedProject = {
                            name: document.getElementById('edit-name').value,
                            description: document.getElementById('edit-description').value,
                            starttime: document.getElementById('edit-starttime').value.replace('T', ' '),
                            endtime: document.getElementById('edit-endtime').value.replace('T', ' '),
                            status: document.getElementById('edit-status').value,
                        };

                        // サーバーにPATCHリクエストを送信
                        const response = await fetch(`/projects/${projectId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedProject),
                        });

                        const response_result = await response.json();
                        if (response_result.success) {
                            fetchProjects();
                            // モーダルを非表示
                            document.getElementById('edit-project-modal').style.display = 'none';
                        } else {
                            alert('Failed to update project: ' + response_result.message);  // エラーメッセージを表示
                        }

                    };

                    // キャンセルボタンの処理
                    document.getElementById('cancel-edit').addEventListener('click', () => {
                        document.getElementById('edit-project-modal').style.display = 'none';
                    });
                }

            
                async function deleteProject(projectId) {
                    const confirmation = confirm(`本当にこのプロジェクトを削除します？`);
                    if (!confirmation) {
                        return;
                    }
            
                    try {
                        const response = await fetch(`/projects/${projectId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        const response_result = await response.json();
            
                        if (response_result.success) {
                            fetchProjects();
                        } else {
                            const errorData = await response.json();
                            alert(`削除失敗： ${errorData.detail}`);
                        }
                    } catch (error) {
                        console.error('Error deleting project:', error);
                        alert('削除処理中にエラーがありました。');
                    }
                }
            </script>

            <div id="edit-project-modal" style="display: none;">
                <p>プロジェクト編集：</p>
                <form id="edit-project-form">
                    <label for="edit-name">プロジェクト名：</label>
                    <input type="text" id="edit-name" required><br>

                    <label for="edit-description">プロジェクト詳細：</label>
                    <textarea id="edit-description" rows="4" required></textarea><br>

                    <label for="edit-starttime">開始日時：</label>
                    <input type="datetime-local" id="edit-starttime" required><br>

                    <label for="edit-endtime">終了日時</label>
                    <input type="datetime-local" id="edit-endtime" required><br>

                    <label for="edit-status">状態：</label>
                    <select id="edit-status" required>
                        <option value="scheduled">予定</option>
                        <option value="ongoing">進行中</option>
                        <option value="Requirements_Definition">要件定義</option>
                        <option value="Basic_Design">基本設計</option>
                        <option value="Detailed_Design">詳細設計</option>
                        <option value="Programming">プログラミング</option>
                        <option value="Unit_Testing">単体テスト</option>
                        <option value="Integration_Testing">結合テスト</option>
                        <option value="System_Testing">システムテスト</option>
                    </select><br>

                    <button type="submit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">保存</button>
                    <button type="button" id="cancel-edit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">取り消す</button>

                </form>
            </div>

            <p>プロジェクトをユーザーに割り当てます：</p>
            <p>本日以前の出席記録は追加されません。</p>
            <p>編集によってプロジェクトの日付が変更された場合、出席記録もそれに応じて更新されます。</p>
            <!--今日より前の出勤記録は登録できないぞ！-->
            <form action="/pm_create_attendance" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="jp">

                <label for="pmasu_the_project_name">プロジェクト名：</label>
                <input type="text" id="pmasu_the_project_name" name="pmasu_the_project_name" required>

                <label for="pmasu_the_user_name">ユーザー名：</label>
                <input type="text" id="pmasu_the_user_name" name="pmasu_the_user_name" required>

                <input type="submit" value="割り当て">
            </form>
            {% if pm_createattendance_message %}
                <div class="message {% if pm_createattendance_success %}success{% else %}error{% endif %}">
                    {{ pm_createattendance_message }}
                </div>
            {% endif %}


            <p>ユーザーへのプロジェクトの割り当てを解除します：</p>
            <form action="/pm_delete_attendance" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="jp">

                <label for="pmuasu_the_project_name">プロジェクト名：</label>
                <input type="text" id="pmuasu_the_project_name" name="pmuasu_the_project_name" required>

                <label for="pmuasu_the_user_name">ユーザー名：</label>
                <input type="text" id="pmuasu_the_user_name" name="pmuasu_the_user_name" required>

                <input type="submit" value="割り当て解除">
            </form>
            {% if pm_deleteattendance_message %}
                <div class="message {% if pm_deleteattendance_success %}success{% else %}error{% endif %}">
                    {{ pm_deleteattendance_message }}
                </div>
            {% endif %}


            <p>出勤情報：</p>

            <button id="show-attendances-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">出勤情報表示</button>
            <button id="hide-attendances-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">出勤情報隠す</button>
            
            <input type="text" id="attendance-and-filterA" placeholder="論理積フェルータ" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>
            <input type="text" id="attendance-and-filterB" placeholder="論理積フェルータ" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>
            <input type="text" id="attendance-and-filterC" placeholder="論理積フェルータ" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>
            
            <button id="calculate-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">出勤率計算</button>
            
            <ul id="attendance-list" style="display: none;">
                <!-- 出席リストがここに表示されます -->
            </ul>
            
            <p id="calculate-output" style="display: none;">This feature is not implemented yet.</p>
            
            <script>
                let attendances = [];
            
                document.getElementById('show-attendances-btn').addEventListener('click', () => {
                    fetchAttendances();
                    document.getElementById('attendance-and-filterA').style.display = 'block';
                    document.getElementById('attendance-and-filterB').style.display = 'block';
                    document.getElementById('attendance-and-filterC').style.display = 'block';
                    document.getElementById('attendance-list').style.display = 'block';
                    document.getElementById('calculate-btn').style.display = 'block';
                    document.getElementById('show-attendances-btn').style.display = 'none';
                    document.getElementById('hide-attendances-btn').style.display = 'block';
                });
            
                document.getElementById('hide-attendances-btn').addEventListener('click', () => {
                    document.getElementById('attendance-and-filterA').style.display = 'none';
                    document.getElementById('attendance-and-filterB').style.display = 'none';
                    document.getElementById('attendance-and-filterC').style.display = 'none';
                    document.getElementById('attendance-list').style.display = 'none';
                    document.getElementById('calculate-btn').style.display = 'none';
                    document.getElementById('hide-attendances-btn').style.display = 'none';
                    document.getElementById('show-attendances-btn').style.display = 'block';
                    document.getElementById('calculate-output').style.display = 'none';
                });
            
                document.getElementById('attendance-and-filterA').addEventListener('input', filterAttendances);
                document.getElementById('attendance-and-filterB').addEventListener('input', filterAttendances);
                document.getElementById('attendance-and-filterC').addEventListener('input', filterAttendances);
            
                async function fetchAttendances() {
                    const response = await fetch('/attendances');
                    attendances = await response.json();
                    displayAttendances(attendances);
                }
            
                function displayAttendances(attendanceList) {
                    const attendanceListElement = document.getElementById('attendance-list');
                    attendanceListElement.innerHTML = ''; // リストをクリア
            
                    attendanceList.forEach(attendance => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>ユーザー名:</strong> ${attendance.user_name} <br>
                            <strong>プロジェクト名:</strong> ${attendance.project_name} <br>
                            <strong>予定日:</strong> ${attendance.date} <br>
                            <strong>予定開始時間:</strong> ${attendance.project_starttime} <br>
                            <strong>予定終了時間:</strong> ${attendance.project_endtime} <br>
                            <strong>チェックイン:</strong> ${attendance.check_in} <br>
                            <strong>チェックアウト:</strong> ${attendance.check_out} <br>
                        `;
                        attendanceListElement.appendChild(listItem);
                    });
                }
            
                function filterAttendances() {
                    const filterValueA = document.getElementById('attendance-and-filterA').value.toLowerCase();
                    const filterValueB = document.getElementById('attendance-and-filterB').value.toLowerCase();
                    const filterValueC = document.getElementById('attendance-and-filterC').value.toLowerCase();

                    // フィルターAを適用
                    const filteredAttendancesA = attendances.filter(attendance => 
                        attendance.user_name.toLowerCase().includes(filterValueA) ||
                        attendance.project_name.toLowerCase().includes(filterValueA) ||
                        attendance.date.toLowerCase().includes(filterValueA)
                    );

                    // フィルターBを適用
                    const filteredAttendancesB = filteredAttendancesA.filter(attendance => 
                        attendance.user_name.toLowerCase().includes(filterValueB) ||
                        attendance.project_name.toLowerCase().includes(filterValueB) ||
                        attendance.date.toLowerCase().includes(filterValueB)
                    );

                    // フィルターCを適用
                    const filteredAttendancesC = filteredAttendancesB.filter(attendance => 
                        attendance.user_name.toLowerCase().includes(filterValueC) ||
                        attendance.project_name.toLowerCase().includes(filterValueC) ||
                        attendance.date.toLowerCase().includes(filterValueC)
                    );

                    // 絞り込んだ結果を表示
                    displayAttendances(filteredAttendancesC);
                }
            
                document.getElementById('calculate-btn').addEventListener('click', () => {
                    calculateAttendanceRate();
                    document.getElementById('calculate-output').style.display = 'block';
                });

                function calculateAttendanceRate() {
                    const filterValueA = document.getElementById('attendance-and-filterA').value.toLowerCase();
                    const filterValueB = document.getElementById('attendance-and-filterB').value.toLowerCase();
                    const filterValueC = document.getElementById('attendance-and-filterC').value.toLowerCase();

                    const filteredAttendancesA = attendances.filter(attendance => 
                        attendance.user_name.toLowerCase().includes(filterValueA) ||
                        attendance.project_name.toLowerCase().includes(filterValueA) ||
                        attendance.date.toLowerCase().includes(filterValueA)
                    );

                    const filteredAttendancesB = filteredAttendancesA.filter(attendance => 
                        attendance.user_name.toLowerCase().includes(filterValueB) ||
                        attendance.project_name.toLowerCase().includes(filterValueB) ||
                        attendance.date.toLowerCase().includes(filterValueB)
                    );

                    const filteredAttendancesC = filteredAttendancesB.filter(attendance => 
                        attendance.user_name.toLowerCase().includes(filterValueC) ||
                        attendance.project_name.toLowerCase().includes(filterValueC) ||
                        attendance.date.toLowerCase().includes(filterValueC)
                    );

                    let outputText = "";
                    let totalRate = 0;
                    let validCount = 0; // 有効な出席レートの数

                    filteredAttendancesC.forEach(attendance => {
                        const scheduledStart = new Date(`1970-01-01T${attendance.project_starttime}:00`);
                        const scheduledEnd = new Date(`1970-01-01T${attendance.project_endtime}:00`);
                        const checkIn = new Date(`1970-01-01T${attendance.check_in}:00`);
                        const checkOut = new Date(`1970-01-01T${attendance.check_out}:00`);

                        const scheduledTime = (scheduledEnd - scheduledStart) / (1000 * 60); // スケジュールされた時間 (分)
                        const actualTime = (checkOut - checkIn) / (1000 * 60); // 実際の働いた時間 (分)

                        let attendanceRate = 0;
                        if (scheduledTime > 0) {
                            attendanceRate = (actualTime / scheduledTime) * 100; // 出席率 (パーセンテージ)
                        }

                        totalRate += attendanceRate;
                        validCount++; // 有効な出席の数を増加

                        outputText += `<strong>${attendance.user_name} - ${attendance.project_name} - ${attendance.date}:</strong> 出勤率： ${attendanceRate.toFixed(2)}%<br>`;
                    });

                    // 出席率の平均を計算
                    let averageRate = validCount > 0 ? (totalRate / validCount).toFixed(2) : 0;

                    // 平均出席率を追加
                    outputText += `<br><strong>平均出勤率：</strong> ${averageRate}%`;

                    document.getElementById('calculate-output').innerHTML = outputText;
                }
            </script>

            <p>新しいタスクを作成する:</p>
            <form action="/pm_create_task" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="jp">

                <label for="pmcreatetask_the_project_name">プロジェクト名:</label>
                <input type="text" id="pmcreatetask_the_project_name" name="pmcreatetask_the_project_name" required>

                <label for="pmcreatetask_the_user_name">ユーザー名(カンマで区切って複数記入可):</label>
                <input type="text" id="pmcreatetask_the_user_name" name="pmcreatetask_the_user_name" required>

                <label for="the_task_startdate">タスク開始日:</label>
                <input type="date" id="the_task_startdate" name="the_task_startdate" required>

                <label for="the_task_enddate">タスク終了日:</label>
                <input type="date" id="the_task_enddate" name="the_task_enddate" required>

                <label for="the_task_status">タスクの説明 (任意):</label>
                <textarea id="the_task_status" name="the_task_status" rows="6" style="width: 100%;" 
                    placeholder="砂糖を7個作る：40%完成&#10;ヒルチャールA：3個完成&#10;ヒルチャールB：1個完成、2個紛失&#10;ヒルチャールC：道端で勇者と出会い、死亡確認中"></textarea>

                <input type="submit" value="送信">
            </form>

            {% if pm_createtask_message %}
                <div class="message {% if pm_createtask_success %}success{% else %}error{% endif %}">
                    {{ pm_createtask_message }}
                </div>
            {% endif %}

            <p>タスクを表示:</p>

            <button id="pmtsk-show-tasks-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">タスク表示</button>
            <button id="pmtsk-hide-tasks-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">タスク隠す</button>

            <input type="text" id="pmtsk-filter-input" placeholder="高性能フェルータ" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>

            <ul id="pmtsk-task-list" style="display: none;">
                <!-- タスクリストがここに表示されます -->
            </ul>

            <script>
                let tasks = [];

                document.getElementById('pmtsk-show-tasks-btn').addEventListener('click', () => {
                    fetchTasks();
                    document.getElementById('pmtsk-filter-input').style.display = 'block';
                    document.getElementById('pmtsk-task-list').style.display = 'block';
                    document.getElementById('pmtsk-show-tasks-btn').style.display = 'none';
                    document.getElementById('pmtsk-hide-tasks-btn').style.display = 'block';
                });

                document.getElementById('pmtsk-hide-tasks-btn').addEventListener('click', () => {
                    document.getElementById('pmtsk-filter-input').style.display = 'none';
                    document.getElementById('pmtsk-task-list').style.display = 'none';
                    document.getElementById('pmtsk-hide-tasks-btn').style.display = 'none';
                    document.getElementById('pmtsk-show-tasks-btn').style.display = 'block';
                });

                document.getElementById('pmtsk-filter-input').addEventListener('input', filterTasks);

                async function fetchTasks() {
                    const response = await fetch(`/tasks`);
                    tasks = await response.json();
                    displayTasks(tasks);
                }

                function displayTasks(taskList) {
                    const taskListElement = document.getElementById('pmtsk-task-list');
                    taskListElement.innerHTML = ''; // リストをクリア

                    taskList.forEach(task => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>プロジェクト：</strong> ${task.project_name} <br>
                            <strong>ユーザー：</strong> ${task.user_name} <br>
                            <strong>開始日</strong> ${task.start_date} <br>
                            <strong>終了日</strong> ${task.end_date} <br>
                            <strong>詳細情報：</strong> ${task.status} <br>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="editTask(${task.id})">編集</button>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="deleteTask(${task.id})">削除</button>
                        `;
                        taskListElement.appendChild(listItem);
                    });
                }

                function filterTasks() {
                    const filterValue = document.getElementById('pmtsk-filter-input').value.toLowerCase();
                    const filteredTasks = tasks.filter(task => 
                        task.project_name.toLowerCase().includes(filterValue) ||
                        task.user_name.toLowerCase().includes(filterValue) ||
                        task.start_date.toLowerCase().includes(filterValue) ||
                        task.end_date.toLowerCase().includes(filterValue) ||
                        (task.status && task.status.toLowerCase().includes(filterValue))
                    );
                    displayTasks(filteredTasks);
                }

                async function editTask(taskId) {
                    const task = tasks.find(t => t.id === taskId);

                    // We could add this back later
                    // document.getElementById('pmtsk-edit-project').value = task.project_name;
                    // document.getElementById('pmtsk-edit-user').value = task.user_name;
                    document.getElementById('pmtsk-edit-startdate').value = task.start_date;
                    document.getElementById('pmtsk-edit-enddate').value = task.end_date;
                    // sometimes status is null so this will gives Uncaught (in promise) TypeError: Cannot set properties of null (setting 'value')
                    // task.status が null または undefined の場合は空文字列を設定
                    document.getElementById('pmtsk-edit-status').value = task.status || '';

                    document.getElementById('pmtsk-edit-task-modal').style.display = 'block';

                    document.getElementById('pmtsk-edit-task-form').onsubmit = async (e) => {
                        e.preventDefault();

                        const updatedTask = {
                            // project_name: document.getElementById('pmtsk-edit-project').value,
                            // user_name: document.getElementById('pmtsk-edit-user').value,
                            start_date: document.getElementById('pmtsk-edit-startdate').value,
                            end_date: document.getElementById('pmtsk-edit-enddate').value,
                            status: document.getElementById('pmtsk-edit-status').value,
                        };

                        const response = await fetch(`/tasks/${taskId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedTask),
                        });

                        const response_result = await response.json();
                        if (response_result.success) {
                            fetchTasks();
                            document.getElementById('pmtsk-edit-task-modal').style.display = 'none';
                        } else {
                            alert('Failed to update task: ' + response_result.message);
                        }
                    };

                    document.getElementById('pmtsk-cancel-edit').addEventListener('click', () => {
                        document.getElementById('pmtsk-edit-task-modal').style.display = 'none';
                    });
                }

                async function deleteTask(taskId) {
                    const confirmation = confirm(`Are you sure you want to delete this task?`);
                    if (!confirmation) {
                        return;
                    }

                    try {
                        const response = await fetch(`/tasks/${taskId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        const response_result = await response.json();

                        if (response_result.success) {
                            fetchTasks();
                        } else {
                            alert(`Failed to delete task: ${response_result.detail}`);
                        }
                    } catch (error) {
                        console.error('Error deleting task:', error);
                        alert('An error occurred while deleting the task.');
                    }
                }
            </script>

            <div id="pmtsk-edit-task-modal" style="display: none;">
                <p>タスク編集：</p>
                <form id="pmtsk-edit-task-form">
                    <!-- <label for="pmtsk-edit-project">Project Name:</label>
                    <input type="text" id="pmtsk-edit-project" required><br>

                    <label for="pmtsk-edit-user">User Name:</label>
                    <input type="text" id="pmtsk-edit-user" required><br> -->

                    <label for="pmtsk-edit-startdate">開始日：</label>
                    <input type="date" id="pmtsk-edit-startdate" required><br>

                    <label for="pmtsk-edit-enddate">終了日：</label>
                    <input type="date" id="pmtsk-edit-enddate" required><br>

                    <label for="pmtsk-edit-status">詳細情報：</label>
                    <textarea id="pmtsk-edit-status" rows="4" ></textarea><br>

                    <button type="submit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">保存</button>
                    <button type="button" id="pmtsk-cancel-edit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">キャンセル</button>
                </form>
            </div>


        {% endif %}

        {% if error %}
            <div class="message error">
                {{ error }}
            </div>
        {% endif %}
    </div>
</body>
</html>
