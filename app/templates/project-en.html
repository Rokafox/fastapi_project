<!DOCTYPE html>
<html>
<head>
    <title>project</title>
    <link rel="stylesheet" type="text/css" href="/static/css/home.css">
    <script>
        const current_user_name = "{{ username }}";
        const page_language = "en";
    </script>
</head>
<body>
    <div class="header-container">
        <h1>Welcome, {{ username }}!</h1>
        <form action="/logout" method="post">
            <input type="submit" value="Logout">
            <input type="hidden" name="lang" value="en">
        </form>
        <nav>
            <a href="/home?username={{ username }}&role={{ role }}&password={{ password }}">Home</a>
        </nav>
        <a class="JPpage" href="/project-jp?username={{ username }}&role={{ role }}&password={{ password }}&lang=jp">Japanese</a>
    </div>
    <div class="container">
        {% if role == 'sysadmin' %}
        <p>You are System administrator.</p>
        {% endif %}
        <p>Create a new project:</p>
            <form action="/sysadmin_create_project" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="en">

                <label for="newproject_name">Project Name:</label>
                <input type="text" id="newproject_name" name="newproject_name" required>

                <label for="newproject_description">Project Description:</label>
                <textarea id="newproject_description" name="newproject_description" rows="4" required></textarea>

                <label for="newproject_startdate">Start Date:</label>
                <input type="date" id="newproject_startdate" name="newproject_startdate" required>

                <label for="newproject_enddate">End Date:</label>
                <input type="date" id="newproject_enddate" name="newproject_enddate" required>

                <label for="newproject_starttime">Start Time:</label>
                <input type="time" id="newproject_starttime" name="newproject_starttime" value="09:00" required>

                <label for="newproject_endtime">End Time:</label>
                <input type="time" id="newproject_endtime" name="newproject_endtime" value="16:00" required>

                <label for="newproject_status">Status:</label>
                <select id="newproject_status" name="newproject_status">
                    <option value="scheduled">Scheduled</option>
                    <option value="ongoing">Ongoing</option>
                    <option value="Requirements_Definition">Requirements Definition</option>
                    <option value="Basic_Design">Basic Design</option>
                    <option value="Detailed_Design">Detailed Design</option>
                    <option value="Programming">Programming</option>
                    <option value="Unit_Testing">Unit Testing</option>
                    <option value="Integration_Testing">Integration Testing</option>
                    <option value="System_Testing">System Testing</option>
                </select>
                <label for="project_manager_names">Project Manager(comma-separated if multiple):</label>
                <input type="text" id="project_manager_names" name="project_manager_names" placeholder="Enter manager names" required>
            
                <input type="submit" value="Create Project">
            </form>

            {% if sysadmin_createproject_message %}
                <div class="message {% if sysadmin_createproject_success %}success{% else %}error{% endif %}">
                    {{ sysadmin_createproject_message }}
                </div>
            {% endif %}

            <p>Retire project manager from a project:</p>
            <form action="/sysadmin_retire_project_manager" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="en">

                <label for="retireprojectmanager_name">Project Manager Name:</label>
                <input type="text" id="retireprojectmanager_name" name="retireprojectmanager_name" required>

                <label for="retireproject_name">Project Name:</label>
                <input type="text" id="retireproject_name" name="retireproject_name" required>
            
                <input type="submit" value="Retire Project Manager">
            </form>
            
            {% if sysadmin_retireprojectmanager_message %}
                <div class="message {% if sysadmin_retireprojectmanager_success %}success{% else %}error{% endif %}">
                    {{ sysadmin_retireprojectmanager_message }}
                </div>
            {% endif %}

            <p>Assign project manager to a project:</p>
            <form action="/sysadmin_assign_project_manager" method="post">
                <input type="hidden" name="username" value="{{ username }}">
                <input type="hidden" name="role" value="{{ role }}">
                <input type="hidden" name="password" value="{{ password }}">
                <input type="hidden" name="lang" value="en">

                <label for="assignprojectmanager_name">Project Manager Name:</label>
                <input type="text" id="assignprojectmanager_name" name="assignprojectmanager_name" required>

                <label for="assignproject_name">Project Name:</label>
                <input type="text" id="assignproject_name" name="assignproject_name" required>
            
                <input type="submit" value="Assign Project Manager">
            </form>
                
            {% if sysadmin_assignprojectmanager_message %}
                <div class="message {% if sysadmin_assignprojectmanager_success %}success{% else %}error{% endif %}">
                    {{ sysadmin_assignprojectmanager_message }}
                </div>
            {% endif %}


            <p>View projects:</p>

            <button id="sysadmin-show-projects-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">Show Projects</button>
            <button id="sysadmin-hide-projects-btn" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; display: none;">Hide Projects</button>
            
            <input type="text" id="sysadmin-filter-input" placeholder="Smart Filter" style="margin-top: 10px; padding: 8px; width: 200px; display: none;"/>
            
            <ul id="sysadmin-project-list" style="display: none;">
                <!-- プロジェクトリストがここに表示されます -->
            </ul>
            
            <script>
                let sysadmin_projects = [];
            
                document.getElementById('sysadmin-show-projects-btn').addEventListener('click', () => {
                    sysadminFetchProjects();
                    document.getElementById('sysadmin-filter-input').style.display = 'block';
                    document.getElementById('sysadmin-project-list').style.display = 'block';
                    document.getElementById('sysadmin-show-projects-btn').style.display = 'none';
                    document.getElementById('sysadmin-hide-projects-btn').style.display = 'block';
                });
            
                document.getElementById('sysadmin-hide-projects-btn').addEventListener('click', () => {
                    document.getElementById('sysadmin-filter-input').style.display = 'none';
                    document.getElementById('sysadmin-project-list').style.display = 'none';
                    document.getElementById('sysadmin-hide-projects-btn').style.display = 'none';
                    document.getElementById('sysadmin-show-projects-btn').style.display = 'block';
                });
            
                document.getElementById('sysadmin-filter-input').addEventListener('input', sysadminFilterProjects);
            
                async function sysadminFetchProjects() {
                    const response = await fetch('/projects');
                    sysadmin_projects = await response.json();
                    sysadminDisplayProjects(sysadmin_projects);
                }
            
                function sysadminDisplayProjects(projectList) {
                    const projectListElement = document.getElementById('sysadmin-project-list');
                    projectListElement.innerHTML = ''; // リストをクリア
            
                    projectList.forEach(project => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>Name:</strong> ${project.name} <br>
                            <strong>Description:</strong> ${project.description} <br>
                            <strong>Start Time:</strong> ${project.starttime} <br>
                            <strong>End Time:</strong> ${project.endtime} <br>
                            <strong>Status:</strong> ${project.status} <br>
                            <strong>Project Manager:</strong> ${project.managers} <br>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="sysadminEditProject(${project.id})">Edit</button>
                            <button style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;" onclick="sysadminDeleteProject(${project.id})">Delete</button>
                        `;
                        projectListElement.appendChild(listItem);
                    });
                }
            
                function sysadminFilterProjects() {
                    const filterValue = document.getElementById('sysadmin-filter-input').value.toLowerCase();
                    // log example project managers
                    // console.log(sysadmin_projects[0].managers); output:
                    // ["kkk"]
                    const filteredProjects = sysadmin_projects.filter(project => 
                        project.name.toLowerCase().includes(filterValue) ||
                        project.description.toLowerCase().includes(filterValue) ||
                        project.starttime.toLowerCase().includes(filterValue) ||
                        project.endtime.toLowerCase().includes(filterValue) ||
                        project.status.toLowerCase().includes(filterValue) ||
                        project.managers.some(manager => manager.toLowerCase().includes(filterValue))
                    );
                    sysadminDisplayProjects(filteredProjects);
                }
            
                async function sysadminEditProject(projectId) {
                    const project = sysadmin_projects.find(p => p.id === projectId);
            
                    document.getElementById('sysadmin-edit-name').value = project.name;
                    document.getElementById('sysadmin-edit-description').value = project.description;
                    document.getElementById('sysadmin-edit-starttime').value = project.starttime;
                    document.getElementById('sysadmin-edit-endtime').value = project.endtime;
                    document.getElementById('sysadmin-edit-status').value = project.status;
            
                    document.getElementById('sysadmin-edit-project-modal').style.display = 'block';
            
                    document.getElementById('sysadmin-edit-project-form').onsubmit = async (e) => {
                        e.preventDefault();
            
                        const updatedProject = {
                            name: document.getElementById('sysadmin-edit-name').value,
                            description: document.getElementById('sysadmin-edit-description').value,
                            starttime: document.getElementById('sysadmin-edit-starttime').value.replace('T', ' '),
                            endtime: document.getElementById('sysadmin-edit-endtime').value.replace('T', ' '),
                            status: document.getElementById('sysadmin-edit-status').value,
                        };
            
                        const response = await fetch(`/projects/${projectId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedProject),
                        });
            
                        const response_result = await response.json();
                        if (response_result.success) {
                            sysadminFetchProjects();
                            document.getElementById('sysadmin-edit-project-modal').style.display = 'none';
                        } else {
                            alert('Failed to update project: ' + response_result.message);
                        }
            
                    };
            
                    document.getElementById('sysadmin-cancel-edit').addEventListener('click', () => {
                        document.getElementById('sysadmin-edit-project-modal').style.display = 'none';
                    });
                }
            
                async function sysadminDeleteProject(projectId) {
                    const confirmation = confirm(`Are you sure you want to delete this project?`);
                    if (!confirmation) {
                        return;
                    }
            
                    try {
                        const response = await fetch(`/projects/${projectId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        const response_result = await response.json();
            
                        if (response_result.success) {
                            sysadminFetchProjects();
                        } else {
                            const errorData = await response.json();
                            alert(`Failed to delete project: ${errorData.detail}`);
                        }
                    } catch (error) {
                        console.error('Error deleting project:', error);
                        alert('An error occurred while deleting the project.');
                    }
                }
            </script>
            
            <div id="sysadmin-edit-project-modal" style="display: none;">
                <p>Edit project:</p>
                <form id="sysadmin-edit-project-form">
                    <label for="sysadmin-edit-name">Name:</label>
                    <input type="text" id="sysadmin-edit-name" required><br>
            
                    <label for="sysadmin-edit-description">Description:</label>
                    <textarea id="sysadmin-edit-description" rows="4" required></textarea><br>
            
                    <label for="sysadmin-edit-starttime">Start Time:</label>
                    <input type="datetime-local" id="sysadmin-edit-starttime" required><br>
            
                    <label for="sysadmin-edit-endtime">End Time:</label>
                    <input type="datetime-local" id="sysadmin-edit-endtime" required><br>
            
                    <label for="sysadmin-edit-status">Status:</label>
                    <select id="sysadmin-edit-status" required>
                        <option value="scheduled">Scheduled</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="Requirements_Definition">Requirements Definition</option>
                        <option value="Basic_Design">Basic Design</option>
                        <option value="Detailed_Design">Detailed Design</option>
                        <option value="Programming">Programming</option>
                        <option value="Unit_Testing">Unit Testing</option>
                        <option value="Integration_Testing">Integration Testing</option>
                        <option value="System_Testing">System Testing</option>
                    </select><br>
            
                    <button type="submit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">Save</button>

                    <button type="button" id="sysadmin-cancel-edit" style="background-color: #333; border: none; color: white; padding: 9px 30px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px;">Cancel</button>
                </form>
            </div>
    </div>
    <script src="/static/js/home.js"></script>
</body>
</html>